FROM php:8.3-cli

# Install system dependencies, Node.js 20, and other tools
RUN apt-get update \
	&& apt-get install -y --no-install-recommends \
	   ca-certificates curl gnupg lsb-release build-essential git unzip zip zlib1g-dev libzip-dev default-mysql-client default-libmysqlclient-dev \
	&& curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
	&& apt-get install -y nodejs \
	&& rm -rf /var/lib/apt/lists/*

# Install PDO MySQL extension
RUN docker-php-ext-install pdo pdo_mysql || true

# Install Composer
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

WORKDIR /app

# Copy PHP and Node dependency manifests first for caching
COPY composer.json composer.lock ./
COPY package*.json ./

# Install PHP dependencies (no scripts to avoid running app code) and Node deps
RUN composer install --no-dev --optimize-autoloader --no-interaction --no-scripts || true
RUN npm ci --silent

# Copy the rest of the app
COPY . .

# Build frontend assets (artisan is available because PHP and vendor exist)
RUN npm run build || true

# Ensure writable directories
RUN chmod -R 775 storage bootstrap/cache || true

ENV PORT=8080
EXPOSE 8080

CMD ["sh", "-c", "php artisan migrate --force && php artisan serve --host=0.0.0.0 --port=${PORT}"]
